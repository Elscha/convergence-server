version: 5
description: Schema to add chat persistence
changes:

########## ChatChannel Class ##########

  - action: CreateClass
    name: ChatChannel
    properties:
      - {name: id,      type: String,                                   constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: type,    type: String,                                   constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: created, type: Date,                                     constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: private, type: Boolean,                                  constraints: {mandatory: true, notNull: true}}
      - {name: name,    type: String,                                   constraints: {mandatory: true, notNull: true}}
      - {name: topic,   type: String,                                   constraints: {mandatory: true, notNull: true}}
      - {name: members, type: LinkList, linkedClass: ChatChannelMember, constraints: {mandatory: true, notNull: true}}

  - action: CreateIndex
    className: ChatChannel
    name: ChatChannel.id
    type: UniqueHashIndex
    properties: [id]

  - action: CreateIndex
    className: ChatChannel
    name: ChatChannel.name_type
    type: UniqueHashIndex
    properties: [name, type]

########## ChatChannelEvent Class ##########

  - action: CreateClass
    name: ChatChannelEvent
    abstract: true
    properties:
      - {name: eventNo,   type: Long,                       constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: channel,   type: Link, linkedClass: ChatChannel, constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: user,      type: Link, linkedClass: User,    constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: timestamp, type: Date,                       constraints: {mandatory: true, notNull: true, readOnly: true}}

  - action: CreateIndex
    className: ChatChannelEvent
    name: ChatChannel.channel_eventNo
    type: UniqueHashIndex
    properties: [channel, eventNo]

  - action: CreateIndex
    className: ChatChannelEvent
    name: ChatChannelEvent.channel
    type: NotUniqueHashIndex
    properties: [channel]

########## ChatMessageEvent Class ##########

  - action: CreateClass
    name: ChatMessageEvent
    superclass: ChatChannelEvent
    properties:
      - {name: message, type: String, constraints: {mandatory: true, notNull: true}}

########## ChatUserJoinedEvent Class ##########

  - action: CreateClass
    name: ChatUserJoinedEvent
    superclass: ChatChannelEvent

########## ChatUserLeftEvent Class ##########

  - action: CreateClass
    name: ChatUserLeftEvent
    superclass: ChatChannelEvent
    
########## ChatUserAddedEvent Class ##########

  - action: CreateClass
    name: ChatUserAddedEvent
    superclass: ChatChannelEvent
    properties:
      - {name: userAdded, type: Link, linkedClass: User, constraints: {mandatory: true, notNull: true, readOnly: true}}
    
########## ChatUserRemovedEvent Class ##########

  - action: CreateClass
    name: ChatUserRemovedEvent
    superclass: ChatChannelEvent
    properties:
      - {name: userRemoved, type: Link, linkedClass: User, constraints: {mandatory: true, notNull: true, readOnly: true}}

########## ChatNameChangedEvent Class ##########

  - action: CreateClass
    name: ChatNameChangedEvent
    superclass: ChatChannelEvent
    properties:
      - {name: name, type: String, constraints: {mandatory: true, notNull: true, readOnly: true}}
      
########## ChatTopicChangedEvent Class ##########

  - action: CreateClass
    name: ChatTopicChangedEvent
    superclass: ChatChannelEvent
    properties:
      - {name: topic, type: String, constraints: {mandatory: true, notNull: true, readOnly: true}}

########## ChatChannelMember Class ##########

  - action: CreateClass
    name: ChatChannelMember

    properties:
      - {name: channel, type: Link, linkedClass: ChatChannel, constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: user,    type: Link, linkedClass: User,    constraints: {mandatory: true, notNull: true, readOnly: true}}
      - {name: seen,    type: Long,                       constraints: {mandatory: true, notNull: true}}

  - action: CreateIndex
    className: ChatChannelMember
    name: ChatChannelUserState.channel_user
    type: UniqueHashIndex
    properties: [channel, user]

  - action: CreateIndex
    className: ChatChannelMember
    name: ChatChannelMember.channel
    type: NotUniqueHashIndex
    properties: [channel]

########## Sequences ##########

  - action: CreateSequence
    name: chatChannelIdSeq
    sequenceType: Ordered
    